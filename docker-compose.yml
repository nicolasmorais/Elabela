version: '3.8'

services:
  web:
    # Replace 'your-github-username/your-repo-name' with the actual image path from GHCR.
    # Users will need to update this to their own image after building with GitHub Actions.
    image: ghcr.io/your-github-username/your-repo-name:latest
    container_name: dyad-app-web

    # Allows for port change: Maps container port 3000 (where Next.js runs)
    # to host port 3000. Users can change the host port (e.g., "8080:3000").
    ports:
      - "3000:3000"

    # Maps a directory to keep the JSON DB file (for persistence).
    # This creates a named volume for persistent data storage,
    # or you can map a host path (e.g., "./data:/app/data").
    volumes:
      - dyad_db_data:/app/data

    # Optionally sets environment variables.
    # These override any ENVs set in the Dockerfile.
    environment:
      NODE_ENV: production
      # Set the DATABASE_DIR to match the volume mapping
      DATABASE_DIR: /app/data
      # Chave de API para ipgeolocation.io (DEVE SER DEFINIDA NO .ENV ou Dyad UI)
      IPGEOLOCATION_API_KEY: d04e5f06615e4ad78f0eb2d479c61ecd
      
      # Variáveis de Conexão PostgreSQL (Usadas pelo serviço 'web')
      DATABASE_URL: postgres://user:password@db:5432/mydatabase
      
    # Depende do serviço de banco de dados
    depends_on:
      - db

    # Restart policy for the container
    restart: unless-stopped

  db:
    image: postgres:16-alpine
    container_name: dyad-app-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: mydatabase
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      # Mapeia a porta do PostgreSQL para a porta 5432 do host (opcional, mas útil para ferramentas externas)
      - "5432:5432"

# Define the named volumes used by the services
volumes:
  dyad_db_data:
  postgres_data: